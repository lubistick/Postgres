# Буферный кэш

В общей памяти экземпляра отводится какой-то кусок памяти, который представляет собой массив буферов.

Каждый буфер хранит в себе одну страницу данных плюс дополнительную информацию - откуда эта страница была прочитана, в каком она состоянии и т.д.

Страница данных, как правило, 8 КБ, указывается при сборке Postgres.

Когда какому-либо процессу для выполнения запроса требуются какие-то данные, он пытается их найти сначала в буферном кэше.

Если там они не нашлись, то процесс обращается к операционной системе и просит ее прочитать соответствующую страницу в буферный кэш.

При этом операционная система ищет данные сначала у себя в кэше.

Если ОС не обнаружила данные у себя в кэше, то она читает фрагмент данных с диска, кладет их себе в кэш, а Postgres оттуда забирает нужную страницу и кладет к себе в кэш.




## Вытеснение редко используемых страниц

В какой-то момент в кэше свободные буферы заканчиваются.

(алгоритм LRU - list reason used)
В кеше остаются те страницы, к которым обращаются более часто. А к которым обращаются редко - вытесняются.

Если мы страницу как-то поменяли, то она считается "грязной" и прежде чем ее выкидывать, ее надо записать обратно на диск.




## Журнал предзаписи (WAL)

Перед тем, как выполнить какое-либо действие со страницей данных, формируется журнальная запись, в которой написано, что мы собираемся поменять.

Журнальная запись должна попасть на диск (в энергонезависимую память) до того, как попадет на диск та страница, которую мы меняем.

Почему это эффективнее, чем просто писать изменения на диск?
Писать страницу на диск - это запись в какое-то произвольное место диска, особенно плохо это работает на крутящемся диске HDD.
Потому что требуется время, чтобы спозиционировать головку на нужную дорожку.
С SSD дисками ситуация лучше, но, тем не менее, такой эффект есть.

А журнал это просто некий постоянный поток на запись. Для него делается обычно отдельный физический диск.

write ahead log

Проблема: при сбое теряются данные из оперативной памяти, не записанные на диск.


Журнал

Поток информации о выполняемых действиях, позволяющий повторно выполнить потерянные при сбое операции

Запись попадает на диск раньше, чем измененные данные


Журнал защищает все, что попадает в буферный кэш.

Страницы таблиц, индексов и других объектов

Статус транзакций (xact)


Журнал не защищает

Временные и нежурналируемые таблицы


