# Очистка

Периодические задачи:

1
Очистка страниц от исторических данных, которые образуются из-за многоверсионности.
Из таблиц вычищаются мертвые версии строк.
Из индексов вычищаются записи, ссылающиеся на мертвые версии.

2
Обновление карты видимости.
Отмечает страницы, на которых все версии строк видны во всех снимках.
Используется для оптимизации работы процесса очистки.
Используется для оптимизации сканирования только индекса (в индексе нет информации о версионности, если страница отмечена в карте видимости, то видимость можно не проверять).
Существует только для таблиц.

3
Обновление карты свободного пространства.
Отмечает свободное пространство в страницах после очистки.
Используется при вставке новых версий строк.
Существует и для таблиц, и для индексов.

4
Обновление статистики.
Используется оптимизатором запросов.
Вычисляется на основе случайной выборки.

5
Заморозка.
Предотвращение последствий переполнения 32-битного счетчика транзакций.



Автоматическая очистка

Autovacuum launcher

Фоновый процесс.
Периодически запускает рабочие процессы.

Autovacuum worker

Очищает таблицы отдельной базы данных, требующие обработки.




Создадим таблицу, в целях эксперимента отключив для нее автоматическую очистку, чтобы контролировать время срабатывания:
```sql
CREATE TABLE bloat(
  id integer GENERATED ALWAYS AS IDENTITY,
  d timestamptz
) WITH (autovacuum_enabled = off);

CREATE TABLE
```

Заполним таблицу данными и создадим индекс:
```sql
INSERT INTO bloat(d) SELECT current_timestamp FROM generate_series(1,100000);

INSERT 0 100000
```















